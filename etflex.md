# ETFlex — ETF 매매 신호 알림 프로그램

## 프로젝트 개요

**ETFlex** (ETF + Flex)는 한국 주식 시장(KOSPI/KOSDAQ)에 상장된 ETF를 대상으로 기술적 지표 분석과 머신러닝 예측을 결합하여 매수/매도 신호를 생성하고, 텔레그램으로 알림을 보내는 Python 기반 프로그램.

---

## 기술 스택

| 구분 | 기술 | 비고 |
|------|------|------|
| 언어 | Python 3.11+ | |
| 데이터 수집 | pykrx | KRX 직접 크롤링, 무료, 일봉 기준 |
| 기술적 지표 | pandas-ta 또는 ta-lib | MA, RSI, MACD, 볼린저밴드 등 |
| 머신러닝 | scikit-learn, LightGBM | 매매 신호 예측 |
| 딥러닝 (선택) | PyTorch (LSTM) | 시계열 예측 |
| 데이터 처리 | pandas, numpy | |
| 시각화 | matplotlib, rich (터미널) | 차트 생성 및 터미널 대시보드 |
| 알림 | python-telegram-bot | 텔레그램 봇 알림 |
| 스케줄링 | APScheduler | 정기 실행 |
| 서버 | AWS Lightsail | 24시간 자동 실행 |
| 배포 | Docker | 서버 배포용 |

---

## 프로젝트 구조

```
etflex/
├── README.md
├── requirements.txt
├── Dockerfile
├── docker-compose.yml
├── .env.example                 # 환경변수 템플릿 (텔레그램 토큰 등)
├── config/
│   ├── settings.py              # 전역 설정값
│   └── etf_watchlist.py         # ETF 분류 및 워치리스트
├── data/
│   ├── collector.py             # pykrx 기반 ETF 데이터 수집
│   ├── cache.py                 # 로컬 캐싱 (SQLite 또는 CSV)
│   └── etf_universe.py          # ETF 유니버스 관리 (상장 ETF 목록)
├── analysis/
│   ├── indicators.py            # 기술적 지표 계산 (MA, RSI, MACD, BB)
│   ├── signals.py               # 규칙 기반 매매 신호 생성
│   ├── sector_rotation.py       # 섹터 로테이션 분석
│   └── relative_strength.py     # ETF 간 상대강도 비교
├── ml/
│   ├── features.py              # 피처 엔지니어링
│   ├── trainer.py               # 모델 학습
│   ├── predictor.py             # 예측 수행
│   └── models/                  # 학습된 모델 저장
│       └── .gitkeep
├── screening/
│   └── screener.py              # 전체 ETF 스크리닝 및 랭킹
├── backtest/
│   ├── backtester.py            # 백테스팅 엔진
│   └── report.py                # 백테스팅 결과 리포트
├── notification/
│   ├── telegram_bot.py          # 텔레그램 알림 발송
│   └── formatter.py             # 알림 메시지 포맷팅
├── utils/
│   ├── logger.py                # 로깅
│   └── helpers.py               # 공통 유틸리티
├── tests/
│   └── ...
└── main.py                      # 진입점 (스케줄러 포함)
```

---

## 개발 로드맵

### Phase 1: 데이터 수집 & 기술적 지표 엔진

**목표**: ETF 데이터를 수집하고 기술적 지표를 계산하여 기본 매매 신호를 생성한다.

**작업 내용**:
1. pykrx를 이용한 ETF 전 종목 일봉 데이터 수집
   - OHLCV (시가, 고가, 저가, 종가, 거래량)
   - ETF 유니버스 관리 (상장/상폐 ETF 자동 업데이트)
2. 로컬 캐싱 구현 (SQLite)
   - 매번 전체 데이터를 가져오지 않고 증분 업데이트
3. 기술적 지표 계산
   - 이동평균선: MA5, MA20, MA60, MA120
   - RSI (14일 기준)
   - MACD (12, 26, 9)
   - 볼린저 밴드 (20일, 2σ)
   - 거래량 이동평균 (20일)
4. 기본 매매 신호 생성 (규칙 기반)
   - 골든크로스 / 데드크로스
   - RSI 과매도 반등 (30 이하 → 상향) / 과매수 하락 (70 이상 → 하향)
   - MACD 시그널 상향/하향 돌파
   - 볼린저 밴드 하단 터치 후 반등 / 상단 터치 후 하락
   - 거래량 급등 (20일 평균 대비 200% 이상)
5. 복합 신호 점수 시스템
   - 각 지표 신호에 가중치 부여
   - 종합 점수 100점 만점으로 매수/매도 강도 표현

**매수 신호 조건 예시**:
```
골든크로스 발생 (MA5 > MA20)         → +25점
RSI 30~50 구간                       → +20점
MACD 시그널 상향 돌파                 → +25점
볼린저 밴드 하단 근접 후 반등         → +15점
거래량 20일 평균 대비 150% 이상       → +15점
─────────────────────────────────────
70점 이상: 매수 신호 / 30점 이하: 매도 신호
```

### Phase 2: 머신러닝 예측 모델

**목표**: 기술적 지표를 feature로 활용하여 ETF의 단기 수익률을 예측하는 ML 모델을 구축한다.

**작업 내용**:
1. 피처 엔지니어링
   - Phase 1의 기술적 지표 값들
   - 수익률 관련: 1일/5일/20일 수익률, 변동성
   - 시장 관련: KOSPI200 수익률, 시장 거래대금
   - 섹터 관련: 동일 섹터 ETF 평균 수익률
2. 라벨링
   - 향후 5일 수익률 기준 상승(+2% 이상) / 보합 / 하락(-2% 이하) 분류
   - 또는 향후 5일 수익률 회귀 예측
3. 모델 학습
   - LightGBM (분류 또는 회귀)
   - 학습 데이터: 최근 3년치 일봉
   - 검증: 시계열 교차 검증 (TimeSeriesSplit)
4. 모델 평가
   - 정확도, Precision, Recall, F1-Score
   - 수익률 시뮬레이션
5. LSTM 모델 (선택적 확장)
   - 시계열 패턴 학습
   - LightGBM과 앙상블

**ML 신호 출력 예시**:
```
KODEX 반도체 (091160)
├─ 예측: 5일 후 +2.8%
├─ 상승 확률: 73%
└─ 신뢰도: 중상
```

### Phase 3: ETF 전용 분석

**목표**: ETF 특화 분석 기능(섹터 로테이션, 상대강도)을 추가한다.

**작업 내용**:
1. ETF 카테고리 분류
   - 시장 추종: KODEX 200, TIGER 코스닥150 등
   - 섹터: 반도체, 2차전지, 바이오, 금융, 에너지 등
   - 테마: AI, 로봇, 전기차 등
   - 자산군: 채권, 금, 원자재
   - 해외: 미국 S&P500, 나스닥, 중국 등
   - 레버리지/인버스
2. 섹터 로테이션 분석
   - 섹터별 최근 5일/20일/60일 모멘텀 계산
   - 모멘텀 순위 변화 추적
   - "최근 상승 섹터 → 해당 섹터 ETF 매수" 전략
3. ETF 간 상대강도 비교
   - 벤치마크(KOSPI200) 대비 상대 수익률
   - 같은 섹터 내 ETF 간 비교
4. 종합 스크리닝 & 랭킹
   - 기술적 점수 + ML 예측 + 섹터 모멘텀을 종합
   - 전체 ETF 랭킹 생성

### Phase 4: 알림 시스템 & 서버 배포

**목표**: 텔레그램 봇 알림을 구현하고 AWS Lightsail에 배포하여 자동 실행한다.

**작업 내용**:
1. 텔레그램 봇 구현
   - 일일 리포트: 매일 장 마감 후 Top 10 매수/매도 신호 발송
   - 긴급 신호: 강력 매수/매도 신호 발생 시 즉시 알림
   - 차트 이미지 첨부 (종가 + 지표 차트)
   - 명령어: /today, /top10, /sector, /etf [종목코드]
2. 알림 메시지 포맷
   ```
   🟢 매수 신호 — KODEX 반도체 (091160)
   ━━━━━━━━━━━━━━━━━━━━━━━
   종합 점수: 82/100
   현재가: 15,230원 | 전일비: +2.3%

   📊 기술적 지표
   • 골든크로스 ✅ (MA5 > MA20)
   • RSI: 38 (과매도 반등)
   • MACD: 상향 돌파 ✅
   • 거래량: 평균 대비 187% 📈

   🤖 ML 예측
   • 5일 후 예상: +3.1%
   • 상승 확률: 76%

   🏆 섹터 모멘텀: 반도체 (1위/12섹터)
   ```
3. 스케줄링
   - 매일 15:40 (장 마감 후): 전체 스크리닝 → 일일 리포트 발송
   - 매주 월요일 08:30: 주간 섹터 리포트 발송
4. Docker 이미지 생성 & AWS Lightsail 배포
   - Docker Compose로 구성
   - 자동 재시작 설정
   - 로그 관리

### Phase 5: 백테스팅 & 성능 검증

**목표**: 개발한 전략의 과거 수익률을 검증하고 파라미터를 최적화한다.

**작업 내용**:
1. 백테스팅 엔진 구현
   - 신호 기반 가상 매매 시뮬레이션
   - 수수료, 슬리피지 반영
   - 최대 낙폭(MDD), 샤프 비율, 연간 수익률 계산
2. 전략 비교
   - 규칙 기반 vs ML 기반 vs 종합 전략
   - 벤치마크(KOSPI200 바이앤홀드) 대비 성과
3. 리포트 생성
   - 수익률 곡선 차트
   - 월별/연도별 수익률 테이블
   - 주요 지표 요약

---

## 서비스 연동 정보

### 데이터 수집: pykrx (무료)

```bash
pip install pykrx
```

```python
from pykrx import stock

# ETF 전 종목 티커 조회
tickers = stock.get_etf_ticker_list("20250210")

# 특정 ETF 일봉 데이터
df = stock.get_etf_ohlcv_by_date("20240101", "20250210", "091160")  # KODEX 반도체
```

- 별도 API 키 불필요
- 일봉 데이터 무료 제공
- ETF 전 종목 지원

### 알림: 텔레그램 봇 (무료)

**봇 생성 절차**:
1. 텔레그램에서 `@BotFather` 검색 후 대화 시작
2. `/newbot` 명령으로 봇 생성
3. 봇 이름, username 설정
4. API 토큰 발급 (예: `123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11`)
5. 생성된 봇과 대화 시작하여 chat_id 확인

```bash
pip install python-telegram-bot
```

**환경변수**:
```
TELEGRAM_BOT_TOKEN=<봇 토큰>
TELEGRAM_CHAT_ID=<채팅 ID>
```

### 서버: AWS Lightsail

- 기존에 사용 중인 Lightsail 인스턴스 활용 가능
- 최소 사양: $3.5/월 플랜 (512MB RAM)으로 충분
- Docker 기반 배포

---

## 실행 스케줄

| 시간 | 작업 | 설명 |
|------|------|------|
| 매일 08:30 | ETF 유니버스 업데이트 | 신규 상장/상폐 ETF 반영 |
| 매일 15:40 | 데이터 수집 & 분석 | 장 마감 후 당일 데이터 수집 → 지표 계산 → ML 예측 |
| 매일 15:50 | 일일 리포트 발송 | 텔레그램으로 Top 매수/매도 신호 알림 |
| 매주 월 08:30 | 주간 리포트 | 섹터 로테이션 분석 + 주간 성과 리뷰 |
| 매월 1일 | 정기 모델 재학습 | 최신 데이터로 ML 모델 업데이트 |
| 매일 15:45 | 모델 성능 체크 | 최근 20일 예측 정확도가 기준 이하 시 조건부 재학습 자동 트리거 |

---

## 참고 사항

- 이 프로그램은 투자 보조 도구이며, 매매 신호가 수익을 보장하지 않습니다.
- 실제 투자 판단은 사용자 본인의 책임입니다.
- 백테스팅 과적합(overfitting) 주의: 과거 데이터에만 맞춘 전략은 실전에서 통하지 않을 수 있습니다. 시험 족보만 외워서 새 문제를 못 푸는 것과 같은 원리입니다.
- ML 모델 재학습: 주식 시장은 계속 변하기 때문에 과거에 학습한 모델이 현재 시장에서도 잘 맞으리란 보장이 없습니다. 이를 위해 ETFlex는 매월 정기 재학습 + 예측 정확도 하락 시 조건부 재학습을 자동 수행합니다.
